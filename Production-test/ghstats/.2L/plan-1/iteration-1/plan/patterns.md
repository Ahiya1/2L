# Code Patterns & Conventions

## File Structure

```
ghstats/
├── .gitignore              # Exclude node_modules
├── package.json            # Dependencies, engines, bin config
├── package-lock.json       # (generated by npm install)
├── ghstats.js              # Entry point, CLI setup, orchestration
├── lib/
│   ├── api-client.js       # GitHub API interaction, error handling
│   └── formatter.js        # Output formatting, number display
└── README.md               # Usage documentation
```

**Key Principles:**
- **ghstats.js**: Entry point only - CLI setup, orchestration, error handling
- **lib/api-client.js**: All GitHub API logic, fetch calls, timeout handling
- **lib/formatter.js**: Output formatting, number localization
- Keep each module focused on single responsibility
- Use ES modules (import/export) throughout

---

## Naming Conventions

**Files:**
- CLI entry point: `ghstats.js` (lowercase, no prefix)
- Library modules: `api-client.js`, `formatter.js` (kebab-case)
- Config files: `package.json`, `.gitignore` (standard names)

**Functions:**
- Exported functions: `fetchRepoStats`, `formatStats`, `displayStats` (camelCase)
- Helper functions: `validateRepository`, `handleError` (camelCase)
- Async functions: Always prefix with `async`, use `await` internally

**Variables:**
- Local variables: `owner`, `repo`, `stats`, `response` (camelCase)
- Constants: `API_TIMEOUT`, `API_BASE_URL` (SCREAMING_SNAKE_CASE)
- Objects: `stats`, `formatted`, `data` (camelCase)

**Error Messages:**
- Start with "Error: " or "✗ Error:"
- Include context (repository name) when relevant
- End with actionable suggestion or help text

---

## Project Setup Pattern

### package.json

**When to create:** First step of project setup

**Full implementation:**
```json
{
  "name": "ghstats",
  "version": "1.0.0",
  "description": "CLI tool to fetch GitHub repository statistics",
  "type": "module",
  "main": "ghstats.js",
  "bin": {
    "ghstats": "./ghstats.js"
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "keywords": [
    "github",
    "cli",
    "statistics",
    "repository"
  ],
  "author": "",
  "license": "MIT",
  "dependencies": {
    "commander": "^12.0.0"
  },
  "scripts": {
    "start": "node ghstats.js"
  }
}
```

**Key points:**
- `"type": "module"` is REQUIRED for ES modules
- `"engines"` enforces Node.js 18+ requirement
- `"bin"` enables global installation with npm link
- Only one production dependency: commander

### .gitignore

**When to create:** Project setup

**Full implementation:**
```
node_modules/
npm-debug.log
.DS_Store
.env
```

**Key points:**
- Always exclude node_modules
- Include .env even though not used (future-proofing)
- .DS_Store for macOS compatibility

---

## CLI Entry Point Pattern

### ghstats.js - Complete Implementation

**When to use:** Main entry point for CLI tool

**Full working code:**
```javascript
#!/usr/bin/env node
import { Command } from 'commander';
import { fetchRepoStats } from './lib/api-client.js';
import { formatStats, displayStats } from './lib/formatter.js';

const program = new Command();

program
  .name('ghstats')
  .description('Fetch GitHub repository statistics')
  .version('1.0.0')
  .argument('<repository>', 'Repository in format owner/repo')
  .action(async (repository) => {
    try {
      // Validate input format
      const pattern = /^[a-zA-Z0-9_.-]+\/[a-zA-Z0-9_.-]+$/;
      if (!pattern.test(repository)) {
        throw new Error(
          `Invalid repository format: "${repository}"\n` +
          `Expected format: owner/repo\n` +
          `Example: facebook/react`
        );
      }

      // Parse owner/repo
      const [owner, repo] = repository.split('/');

      // Show loading indicator
      console.log('Fetching repository statistics...\n');

      // Fetch stats from GitHub API
      const stats = await fetchRepoStats(owner, repo);

      // Format and display
      const formatted = formatStats(stats);
      displayStats(repository, formatted);

      // Exit successfully
      process.exit(0);

    } catch (error) {
      handleError(error, repository);
    }
  })
  .parse();

// Centralized error handler
function handleError(error, repository) {
  const errorPrefix = '\n✗ Error:';

  // Repository not found (404)
  if (error.message.includes('not found')) {
    console.error(`${errorPrefix} Repository '${repository}' not found`);
    console.error('\nPlease check:');
    console.error('  • Repository name spelling');
    console.error('  • Repository visibility (must be public)');
    console.error('  • Owner username\n');
    process.exit(1);
  }

  // Rate limit exceeded (403)
  if (error.message.includes('Rate limit exceeded')) {
    console.error(`${errorPrefix} ${error.message}`);
    console.error('\nUnauthenticated requests are limited to 60 per hour.');
    console.error('Wait for the reset time or consider authentication.\n');
    process.exit(1);
  }

  // Network timeout
  if (error.message.includes('timeout')) {
    console.error(`${errorPrefix} ${error.message}`);
    console.error('\nPlease check your internet connection and try again.\n');
    process.exit(1);
  }

  // Invalid input format
  if (error.message.includes('Invalid repository format')) {
    console.error(`${errorPrefix} ${error.message}\n`);
    process.exit(1);
  }

  // Generic network/unknown error
  console.error(`${errorPrefix} ${error.message}`);
  console.error('\nIf the problem persists, check GitHub API status.\n');
  process.exit(1);
}
```

**Key points:**
- `#!/usr/bin/env node` shebang enables direct execution
- Must include `.js` extension in ES module imports
- Input validation happens before API call (fail fast)
- Loading indicator improves UX during network wait
- Centralized error handler provides consistent messaging
- Exit code 0 on success, 1 on all errors
- Error messages include actionable suggestions

---

## API Client Pattern

### lib/api-client.js - Complete Implementation

**When to use:** All GitHub API interactions

**Full working code:**
```javascript
// lib/api-client.js
const API_BASE_URL = 'https://api.github.com';
const API_TIMEOUT = 10000; // 10 seconds

/**
 * Fetch repository statistics from GitHub API
 * @param {string} owner - Repository owner username
 * @param {string} repo - Repository name
 * @returns {Promise<Object>} Statistics object with stars, forks, issues, watchers
 * @throws {Error} On API errors, network failures, or timeout
 */
export async function fetchRepoStats(owner, repo) {
  // Set up timeout with AbortController
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);

  try {
    // Make API request
    const response = await fetch(
      `${API_BASE_URL}/repos/${owner}/${repo}`,
      {
        signal: controller.signal,
        headers: {
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'ghstats-cli'
        }
      }
    );

    // Clear timeout on successful response
    clearTimeout(timeoutId);

    // Check response status
    if (!response.ok) {
      // Repository not found
      if (response.status === 404) {
        throw new Error(`Repository '${owner}/${repo}' not found`);
      }

      // Rate limit exceeded
      if (response.status === 403) {
        const resetTime = response.headers.get('x-ratelimit-reset');
        if (resetTime) {
          const resetDate = new Date(parseInt(resetTime) * 1000);
          throw new Error(
            `Rate limit exceeded. Resets at ${resetDate.toLocaleString()}`
          );
        }
        throw new Error('Rate limit exceeded');
      }

      // Other HTTP errors
      throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
    }

    // Parse JSON response
    const data = await response.json();

    // Extract required fields
    // CRITICAL: Use subscribers_count for watchers, NOT watchers_count
    // (watchers_count duplicates stargazers_count due to GitHub API legacy behavior)
    return {
      stars: data.stargazers_count || 0,
      forks: data.forks_count || 0,
      issues: data.open_issues_count || 0,
      watchers: data.subscribers_count || 0
    };

  } catch (error) {
    // Handle timeout specifically
    if (error.name === 'AbortError') {
      throw new Error('Request timeout - GitHub API is not responding');
    }

    // Re-throw other errors for centralized handling
    throw error;

  } finally {
    // Always clear timeout to prevent memory leak
    clearTimeout(timeoutId);
  }
}
```

**Key points:**
- Use AbortController for timeout handling (10 seconds)
- Always clear timeout in finally block
- Check response.ok before parsing JSON (fetch doesn't throw on 4xx/5xx)
- Use `subscribers_count` for watchers (NOT `watchers_count`)
- Extract specific fields with fallback to 0
- Rate limit error includes reset time from headers
- Proper error messages with context (owner/repo)

---

## Output Formatter Pattern

### lib/formatter.js - Complete Implementation

**When to use:** All terminal output formatting

**Full working code:**
```javascript
// lib/formatter.js

/**
 * Format statistics numbers with thousand separators
 * @param {Object} stats - Raw statistics object
 * @returns {Object} Formatted statistics with string numbers
 */
export function formatStats(stats) {
  return {
    stars: stats.stars.toLocaleString('en-US'),
    forks: stats.forks.toLocaleString('en-US'),
    issues: stats.issues.toLocaleString('en-US'),
    watchers: stats.watchers.toLocaleString('en-US')
  };
}

/**
 * Display formatted statistics to terminal
 * @param {string} repository - Repository identifier (owner/repo)
 * @param {Object} formatted - Formatted statistics object
 */
export function displayStats(repository, formatted) {
  const separator = '─'.repeat(40);

  console.log(`\nRepository: ${repository}`);
  console.log(separator);
  console.log(`Stars:        ${formatted.stars.padStart(10)}`);
  console.log(`Forks:        ${formatted.forks.padStart(10)}`);
  console.log(`Open Issues:  ${formatted.issues.padStart(10)}`);
  console.log(`Watchers:     ${formatted.watchers.padStart(10)}`);
  console.log(separator);
  console.log(); // Extra newline for spacing
}
```

**Key points:**
- Use `toLocaleString('en-US')` for thousand separators (1,234 not 1234)
- Right-align numbers with `padStart()` for clean columns
- Consistent separator line (40 dashes)
- Extra newlines for visual breathing room
- Simple console.log (no chalk, no colors, universally compatible)

**Example output:**
```
Repository: facebook/react
────────────────────────────────────────
Stars:           239,697
Forks:            49,565
Open Issues:       1,060
Watchers:          6,500
────────────────────────────────────────
```

---

## Input Validation Pattern

### Validation Function

**When to use:** Before making API calls

**Full implementation (inline in ghstats.js or separate module):**
```javascript
/**
 * Validate repository format
 * @param {string} input - User input repository identifier
 * @returns {Object} Parsed {owner, repo} object
 * @throws {Error} If input format is invalid
 */
function validateRepository(input) {
  // GitHub allows: alphanumeric, hyphens, underscores, dots
  const pattern = /^[a-zA-Z0-9_.-]+\/[a-zA-Z0-9_.-]+$/;

  if (!pattern.test(input)) {
    throw new Error(
      `Invalid repository format: "${input}"\n` +
      `Expected format: owner/repo\n` +
      `Example: facebook/react`
    );
  }

  const [owner, repo] = input.split('/');
  return { owner, repo };
}
```

**Key points:**
- Validate before API call (fail fast, save rate limit)
- Regex pattern matches GitHub username/repo naming rules
- Include example in error message
- Return parsed owner/repo for convenience

---

## Error Handling Pattern

### Centralized Error Handler

**When to use:** Main try-catch block in action handler

**Full implementation:**
```javascript
function handleError(error, repository) {
  const errorPrefix = '\n✗ Error:';

  // Repository not found (404)
  if (error.message.includes('not found')) {
    console.error(`${errorPrefix} Repository '${repository}' not found`);
    console.error('\nPlease check:');
    console.error('  • Repository name spelling');
    console.error('  • Repository visibility (must be public)');
    console.error('  • Owner username\n');
    process.exit(1);
  }

  // Rate limit exceeded (403)
  if (error.message.includes('Rate limit exceeded')) {
    console.error(`${errorPrefix} ${error.message}`);
    console.error('\nUnauthenticated requests are limited to 60 per hour.');
    console.error('Wait for the reset time or consider authentication.\n');
    process.exit(1);
  }

  // Network timeout
  if (error.message.includes('timeout')) {
    console.error(`${errorPrefix} ${error.message}`);
    console.error('\nPlease check your internet connection and try again.\n');
    process.exit(1);
  }

  // Invalid input format
  if (error.message.includes('Invalid repository format')) {
    console.error(`${errorPrefix} ${error.message}\n`);
    process.exit(1);
  }

  // Generic network/unknown error
  console.error(`${errorPrefix} ${error.message}`);
  console.error('\nIf the problem persists, check GitHub API status.\n');
  process.exit(1);
}
```

**Key points:**
- Consistent error prefix for all errors
- Specific handling for 5 error types (validation, 404, 403, timeout, generic)
- Actionable suggestions for each error type
- Exit code 1 for all errors (enables shell scripting)
- Use console.error for errors (not console.log)

---

## Loading Indicator Pattern

### Simple Loading Message

**When to use:** Before API call

**Implementation:**
```javascript
console.log('Fetching repository statistics...\n');
const stats = await fetchRepoStats(owner, repo);
// Results display clears the loading message naturally
```

**Key points:**
- Simple text message (no spinner dependencies)
- Prevents perceived hanging during 100-500ms API call
- Extra newline for visual separation

### Advanced Spinner (Optional)

**When to use:** Enhanced UX (optional, not required for MVP)

**Implementation (no dependencies):**
```javascript
const frames = ['⠋', '⠙', '⠹', '⠸', '⠼', '⠴', '⠦', '⠧', '⠇', '⠏'];
let i = 0;

const spinner = setInterval(() => {
  process.stdout.write(`\r${frames[i]} Fetching repository statistics...`);
  i = (i + 1) % frames.length;
}, 80);

try {
  const stats = await fetchRepoStats(owner, repo);
  clearInterval(spinner);
  process.stdout.write('\r' + ' '.repeat(50) + '\r'); // Clear spinner line
  // Display results
} catch (error) {
  clearInterval(spinner);
  process.stdout.write('\r' + ' '.repeat(50) + '\r'); // Clear spinner line
  throw error;
}
```

**Key points:**
- No dependencies (uses Unicode spinner characters)
- Always clear interval in try-catch-finally
- Clear spinner line before displaying results
- 80ms frame rate for smooth animation

---

## Import Order Convention

**Standard import order:**
```javascript
// 1. Node.js built-ins (none in this project)

// 2. External dependencies (npm packages)
import { Command } from 'commander';

// 3. Local modules (relative imports, always include .js extension)
import { fetchRepoStats } from './lib/api-client.js';
import { formatStats, displayStats } from './lib/formatter.js';

// 4. Constants
const API_TIMEOUT = 10000;
```

**Key points:**
- Group imports by type (built-ins, npm, local)
- Always include `.js` extension for ES modules
- Blank line between import groups
- Constants after imports

---

## Testing Pattern

### Manual Testing Checklist

**Happy Path Testing:**
```bash
# Test popular repositories
node ghstats.js facebook/react
node ghstats.js microsoft/vscode
node ghstats.js torvalds/linux

# Expected: Statistics display with thousand separators
```

**Error Testing:**
```bash
# Invalid format
node ghstats.js invalid-format
node ghstats.js owner/repo/extra
# Expected: "Invalid repository format" with example

# Repository not found (404)
node ghstats.js nonexistent/fake
node ghstats.js invaliduser/invalidrepo
# Expected: "Repository not found" with suggestions

# Rate limit (hard to test without 60+ requests)
# Manually verify 403 handling logic

# Network timeout
# Temporarily disconnect internet, run command
# Expected: "Request timeout" message

# Help text
node ghstats.js --help
node ghstats.js -h
# Expected: Usage instructions with examples

# Version
node ghstats.js --version
# Expected: "1.0.0"
```

**Exit Code Testing:**
```bash
# Success
node ghstats.js facebook/react && echo "Success: $?"
# Expected: Statistics + "Success: 0"

# Failure
node ghstats.js invalid && echo "Failed: $?" || echo "Failed: $?"
# Expected: Error message + "Failed: 1"
```

---

## README Pattern

### README.md Structure

**When to create:** Final step, documentation phase

**Full implementation:**
```markdown
# ghstats - GitHub Repository Statistics CLI

Fetch and display GitHub repository statistics from the command line.

## Prerequisites

- **Node.js 18 or higher** (for built-in fetch API support)
- Check your version: `node --version`
- Install/upgrade: https://nodejs.org

## Installation

```bash
# Clone or download this project
cd ghstats

# Install dependencies
npm install

# Optional: Make globally available
npm link
```

## Usage

### Basic Usage

```bash
node ghstats.js <owner/repo>
```

### Examples

```bash
# Popular repositories
node ghstats.js facebook/react
node ghstats.js microsoft/vscode
node ghstats.js torvalds/linux

# Your own repository
node ghstats.js yourusername/yourrepo
```

### If Globally Installed (npm link)

```bash
ghstats facebook/react
```

## Output

```
Fetching repository statistics...

Repository: facebook/react
────────────────────────────────────────
Stars:           239,697
Forks:            49,565
Open Issues:       1,060
Watchers:          6,500
────────────────────────────────────────
```

## Options

```bash
ghstats --help     # Display help text
ghstats --version  # Display version
```

## Error Handling

The tool handles common errors gracefully:

- **Invalid format**: Displays usage example
- **Repository not found**: Suggests checking spelling and visibility
- **Rate limit exceeded**: Shows reset time (60 requests/hour limit)
- **Network errors**: Prompts to check internet connection

## How It Works

1. Validates repository format (owner/repo)
2. Fetches data from GitHub REST API v3
3. Displays formatted statistics

**Note:** Uses unauthenticated API (60 requests/hour limit). For higher limits, consider GitHub authentication.

## License

MIT

## Author

[Your Name]
```

**Key points:**
- Prominently display Node.js 18+ requirement
- Include real examples with popular repositories
- Document both local and global usage
- Explain error scenarios users will encounter
- Keep it concise (users want to use tool, not read essays)

---

## Code Quality Standards

### Function Documentation

**Use JSDoc comments for exported functions:**
```javascript
/**
 * Fetch repository statistics from GitHub API
 * @param {string} owner - Repository owner username
 * @param {string} repo - Repository name
 * @returns {Promise<Object>} Statistics object
 * @throws {Error} On API errors or network failures
 */
export async function fetchRepoStats(owner, repo) {
  // Implementation
}
```

### Error Messages

**Good error message:**
```
✗ Error: Repository 'facebook/invalidrepo' not found

Please check:
  • Repository name spelling
  • Repository visibility (must be public)
  • Owner username
```

**Bad error message:**
```
Error: 404
```

**Principles:**
- Include context (what failed)
- Provide actionable suggestions
- Use bullet points for multiple checks
- Add extra newlines for readability

### Async/Await Pattern

**Always use async/await (never callbacks or raw promises):**
```javascript
// GOOD
async function main() {
  try {
    const stats = await fetchRepoStats(owner, repo);
    console.log(stats);
  } catch (error) {
    console.error(error.message);
  }
}

// BAD - Don't use .then()/.catch()
function main() {
  fetchRepoStats(owner, repo)
    .then(stats => console.log(stats))
    .catch(error => console.error(error));
}
```

---

## Performance Best Practices

### Fail Fast

**Validate input before expensive operations:**
```javascript
// GOOD - Validate first
if (!pattern.test(repository)) {
  throw new Error('Invalid format');
}
const stats = await fetchRepoStats(owner, repo); // Only call if valid

// BAD - API call before validation
const stats = await fetchRepoStats(owner, repo); // Wastes API quota
if (!pattern.test(repository)) {
  throw new Error('Invalid format');
}
```

### Timeout Handling

**Always set timeout to prevent hanging:**
```javascript
// GOOD - 10 second timeout
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 10000);

try {
  const response = await fetch(url, { signal: controller.signal });
} finally {
  clearTimeout(timeoutId); // Prevent memory leak
}
```

### Number Formatting

**Use built-in toLocaleString (no libraries needed):**
```javascript
// GOOD - Built-in formatting
const formatted = 239697.toLocaleString('en-US'); // "239,697"

// BAD - Manual formatting (unnecessary complexity)
function formatNumber(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}
```

---

## Git Commit Patterns

**Suggested commit messages:**
```
Initial commit: Project setup with package.json

Add CLI skeleton with commander.js

Implement GitHub API client with error handling

Add output formatter with number localization

Implement comprehensive error handling

Add README documentation

Test with real repositories and fix edge cases
```

**Key points:**
- Start with verb (Add, Implement, Fix, Update)
- Be specific but concise
- One logical change per commit
- Test before committing

---

## Common Pitfalls to Avoid

### 1. Forgetting .js Extension in Imports

```javascript
// WRONG - ES modules require extension
import { fetchRepoStats } from './lib/api-client';

// CORRECT - Always include .js
import { fetchRepoStats } from './lib/api-client.js';
```

### 2. Using watchers_count Instead of subscribers_count

```javascript
// WRONG - watchers_count duplicates stargazers_count
return {
  stars: data.stargazers_count,
  watchers: data.watchers_count // Same as stars!
};

// CORRECT - Use subscribers_count for actual watchers
return {
  stars: data.stargazers_count,
  watchers: data.subscribers_count // Different value
};
```

### 3. Not Checking response.ok Before JSON Parsing

```javascript
// WRONG - fetch doesn't throw on 404
const response = await fetch(url);
const data = await response.json(); // Throws on 404 HTML response

// CORRECT - Check status first
const response = await fetch(url);
if (!response.ok) {
  throw new Error(`HTTP ${response.status}`);
}
const data = await response.json();
```

### 4. Forgetting to Clear Timeout

```javascript
// WRONG - Memory leak
const timeoutId = setTimeout(() => controller.abort(), 10000);
const response = await fetch(url, { signal: controller.signal });

// CORRECT - Always clear in finally
try {
  const response = await fetch(url, { signal: controller.signal });
} finally {
  clearTimeout(timeoutId);
}
```

### 5. Missing "type": "module" in package.json

```json
// WRONG - Defaults to CommonJS
{
  "name": "ghstats",
  "dependencies": {
    "commander": "^12.0.0"
  }
}

// CORRECT - Enable ES modules
{
  "name": "ghstats",
  "type": "module",
  "dependencies": {
    "commander": "^12.0.0"
  }
}
```

---

*These patterns represent the complete, production-ready implementation guide.*
*Copy and adapt these patterns for consistent, high-quality code.*
